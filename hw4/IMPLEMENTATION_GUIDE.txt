================================================================================
æ–¹æ¡ˆ A+B å®æ–½å¿«é€ŸæŒ‡å—
================================================================================

## ğŸ¯ ç›®æ ‡
case01: 4.20s â†’ 2.0-2.5s

## ğŸ“‹ å®æ–½é¡ºåº

### ç¬¬ä¸€æ­¥ï¼šæ–¹æ¡ˆ B - Kernel ä¼˜åŒ– (2-3å°æ—¶)

1. **B.1 ä¼˜åŒ– shared memory åŠ è½½** (ç¬¬ 476-486 è¡Œ)
   æ”¹ä¸ºè®©å‰ 8 ä¸ª threads åŒæ—¶åŠ è½½ midstate å’Œ chunk1_base

2. **B.2 ç¡¬ä»¶å­—èŠ‚åºè½¬æ¢** (ç¬¬ 512-515 è¡Œ)
   ç”¨ `__byte_perm(nonce, 0, 0x0123)` æ›¿æ¢æ‰‹åŠ¨ä½æ“ä½œ

3. **B.3 å‡å°‘ register ä½¿ç”¨** â­â­â­ (ç¬¬ 500-530 è¡Œ)
   å¤ç”¨ chunk1 æ•°ç»„å­˜å‚¨ intermediate
   ä» 56 registers â†’ 24 registers (-32!)

4. **B.4 ä¼˜åŒ– early exit** (ç¬¬ 492-495 è¡Œ)
   åŠ¨æ€è°ƒæ•´æ£€æŸ¥é¢‘ç‡ï¼šå‰æœŸ 128 æ¬¡/æ£€æŸ¥ï¼ŒåæœŸ 32 æ¬¡/æ£€æŸ¥

**æµ‹è¯•ï¼š**
```bash
make
./hw4 testcases/case01.in outputs/case01_b.out
diff outputs/case01_b.out testcases/case01.out  # ç¡®è®¤æ­£ç¡®
/usr/bin/time -v ./hw4 testcases/case01.in outputs/case01_b.out
```

**é¢„æœŸï¼š** 4.20s â†’ 3.6-3.8s âœ“

---

### ç¬¬äºŒæ­¥ï¼šæ–¹æ¡ˆ A - Prefetch Pipeline (4-6å°æ—¶)

1. **A.1 æ–°å¢ PrefetchContext ç»“æ„** (ç¬¬ 604 è¡Œå)
   ç®¡ç† prefetch çŠ¶æ€ï¼ševents, chunks_launched, prefetch_window ç­‰

2. **A.2 ä¿®æ”¹ mine_kernel_global å¼€å¤´**
   æ·»åŠ ï¼š`if (*found) return;`  // å¿«é€Ÿé€€å‡º

3. **A.3 å®Œå…¨é‡å†™ mine_blocks_pipeline**
   - åˆå§‹åŒ–ï¼šé¢„å…ˆ launch 4 ä¸ª kernels
   - ä¸»å¾ªç¯ï¼š
     * Phase 1: æ£€æŸ¥å®Œæˆï¼Œå–å›ç»“æœ
     * Phase 2: Launch æ–° kernels ç»´æŒçª—å£
   - æ¸…ç†ï¼šé‡Šæ”¾èµ„æº

**æµ‹è¯•ï¼š**
```bash
make
./hw4 testcases/case01.in outputs/case01_ab.out
diff outputs/case01_ab.out testcases/case01.out  # ç¡®è®¤æ­£ç¡®
/usr/bin/time -v ./hw4 testcases/case01.in outputs/case01_ab.out
nsys profile --stats=true ./hw4 testcases/case01.in outputs/case01_ab.out
```

**é¢„æœŸï¼š** 3.6-3.8s â†’ 2.0-2.5s âœ“âœ“âœ“

---

## ğŸ”‘ å…³é”®ä»£ç ç‰‡æ®µ

### B.3 Register ä¼˜åŒ–ï¼ˆæœ€é‡è¦ï¼‰
```cuda
// åˆ é™¤è¿™è¡Œ
// unsigned char intermediate[32];  // -32 registers!

// ç¬¬ä¸€æ¬¡ hash
device_sha256_transform_words(state, chunk1);

// å¤ç”¨ chunk1[0-7] å­˜å‚¨ç»“æœ
for (int j = 0; j < 8; ++j) {
    chunk1[j] = state[j];
}

// ç¬¬äºŒæ¬¡ hashï¼ˆç›´æ¥ä» chunk1 è¯»å–ï¼‰
device_sha256(&hash, (unsigned char*)chunk1, 32);
```

### A.3 Prefetch ä¸»å¾ªç¯
```cpp
// é¢„å…ˆ launch 4 ä¸ª kernels
for (int w = 0; w < 4; ++w) {
    mine_kernel_global<<<...>>>(start_nonce + w*16M, ...);
    cudaEventRecord(events[w], stream);
}

// ä¸»å¾ªç¯ï¼šç»´æŒçª—å£
while (...) {
    if (cudaEventQuery(event) == cudaSuccess) {
        // æ£€æŸ¥ç»“æœ
        if (found) { /* åœæ­¢ */ }
        else { /* launch ä¸‹ä¸€ä¸ª */ }
    }
}
```

---

## âš ï¸  æ³¨æ„äº‹é¡¹

1. **ä¿å­˜ backup**: `cp hw4.cu hw4_backup.cu`
2. **åˆ†é˜¶æ®µæµ‹è¯•**: æ¯ä¸ªä¼˜åŒ–åéƒ½æµ‹è¯•
3. **Profile éªŒè¯**: ç”¨ nsys ç¡®è®¤ overlap æå‡
4. **æ­£ç¡®æ€§ä¼˜å…ˆ**: ä»»ä½•æµ‹è¯•å¤±è´¥éƒ½è¦å…ˆä¿®å¤

---

## ğŸ“Š é¢„æœŸæ€§èƒ½

| é˜¶æ®µ | æ—¶é—´ | æ”¹å–„ | æœºåˆ¶ |
|------|------|------|------|
| å½“å‰ | 4.20s | - | åŸºçº¿ |
| +B | 3.65s | -13% | Kernel åŠ é€Ÿ |
| +A | 2.20s | -48% | Overlap æå‡ |

**è¾¾æ ‡ï¼š** 2.0-2.5s < 3.0-3.5s âœ“âœ“âœ“

================================================================================

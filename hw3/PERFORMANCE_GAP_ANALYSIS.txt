
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         æ€§èƒ½å·®è·æ·±åº¦åˆ†æ - ä¸ºä»€ä¹ˆæ…¢ 2.57 å€ï¼Ÿ                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“Š æ’è¡Œæ¦œæ•°æ®åˆ†æ

å½“å‰æ’åï¼š50 / æ€»æ—¶é—´ï¼š17.23s
ç¬¬ 1 åï¼šb11901003 / æ€»æ—¶é—´ï¼š6.71s
å·®è·ï¼š2.57Ã— 

è¯¦ç»†å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test  â”‚ ä½ çš„æˆç»©  â”‚ ç¬¬1å   â”‚ å·®è·   â”‚ åˆ†æ          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 02    â”‚ 0.62s     â”‚ 0.46s   â”‚ 1.35Ã—  â”‚ å·®è·å°        â”‚
â”‚ 04    â”‚ 0.92s     â”‚ 0.61s   â”‚ 1.51Ã—  â”‚ å¼€å§‹æ‹‰å¤§      â”‚
â”‚ 06    â”‚ 6.82s     â”‚ 2.57s   â”‚ 2.65Ã—  â”‚ âŒ å·®è·å·¨å¤§   â”‚
â”‚ 08    â”‚ 8.88s     â”‚ 3.07s   â”‚ 2.89Ã—  â”‚ âŒ æœ€å¤§å·®è·   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ” å…³é”®å‘ç°

### å‘ç° 1: æ‰©å±•æ€§é—®é¢˜ âš ï¸âš ï¸âš ï¸
å°æµ‹è¯•æ¡ˆä¾‹ï¼šå·®è·ä¸å¤§ï¼ˆ1.35Ã—ï¼‰
å¤§æµ‹è¯•æ¡ˆä¾‹ï¼šå·®è·å·¨å¤§ï¼ˆ2.89Ã—ï¼‰

ç»“è®ºï¼šä½ çš„ä»£ç åœ¨å¤§è§„æ¨¡æ•°æ®æ—¶æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼
é—®é¢˜ï¼šScalabilityï¼ˆå¯æ‰©å±•æ€§ï¼‰ä¸è¶³

### å‘ç° 2: ç“¶é¢ˆåœ¨å“ªï¼Ÿ
Test 06: 4096Ã—4096 = 16,777,216 pixels
Test 08: 4096Ã—4096 = 16,777,216 pixels

é—®é¢˜ä¸åœ¨ pixel æ•°é‡ï¼ˆéƒ½æ˜¯ 4096Â²ï¼‰ï¼Œè€Œåœ¨ï¼š
  1. è®¡ç®—å¤æ‚åº¦å·®å¼‚ï¼ˆä¸åŒåœºæ™¯ï¼‰
  2. Memory bandwidth é¥±å’Œ
  3. Cache miss ç‡å¢åŠ 
  4. Occupancy ä¸è¶³

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ’¡ å¯èƒ½çš„ç“¶é¢ˆåˆ†æ

### ç“¶é¢ˆ 1: Block Size ä¸ä¼˜ âš ï¸âš ï¸âš ï¸

å½“å‰é…ç½®ï¼š
  blockDim = (16, 16) = 256 threads/block
  Register usage: 60 regs/thread
  
è®¡ç®— Occupancy:
  SM_70 (V100): 
  - Max threads/SM: 2048
  - Max blocks/SM: 32
  - Register file: 65536 regs/SM
  
  å®é™…ï¼š
  - Regs/block: 60 Ã— 256 = 15,360
  - Blocks/SM: 65536 / 15,360 = 4.26 â†’ 4 blocks
  - Threads/SM: 4 Ã— 256 = 1024
  - Occupancy: 1024 / 2048 = 50%

é—®é¢˜ï¼šåªæœ‰ 50% occupancyï¼æ— æ³•å……åˆ†åˆ©ç”¨ GPUï¼

ä¼˜åŒ–æ–¹å‘ï¼š
  1. å‡å°‘ register ä½¿ç”¨
  2. è°ƒæ•´ block sizeï¼ˆå¯èƒ½ 32Ã—8 æˆ– 64Ã—4 æ›´å¥½ï¼‰
  3. ä½¿ç”¨ __launch_bounds__ é™åˆ¶å¯„å­˜å™¨

### ç“¶é¢ˆ 2: å†…å­˜è®¿é—®æ¨¡å¼ âš ï¸âš ï¸

å½“å‰é—®é¢˜ï¼š
```cpp
int idx = i * width * 4 + j * 4;
image[idx + 0] = (unsigned char)fcol.x;
image[idx + 1] = (unsigned char)fcol.y;
image[idx + 2] = (unsigned char)fcol.z;
image[idx + 3] = 255;
```

é—®é¢˜ï¼š
  â€¢ æ¯ä¸ª thread å†™ 4 ä¸ªå­—èŠ‚ï¼ˆRGBAï¼‰
  â€¢ å¯èƒ½å¯¼è‡´ non-coalesced access
  â€¢ Bank conflictï¼ˆåœ¨æŸäº›æ¶æ„ä¸Šï¼‰

ä¼˜åŒ–æ–¹å‘ï¼š
  1. ä½¿ç”¨ uchar4 å‘é‡ç±»å‹
  2. ä¸€æ¬¡å†™å…¥ 4 å­—èŠ‚ï¼ˆæ›´å¥½çš„ coalescingï¼‰
  3. è€ƒè™‘ä½¿ç”¨ shared memory

### ç“¶é¢ˆ 3: Constant Memory è¿‡åº¦ä½¿ç”¨ âš ï¸

å½“å‰ä½¿ç”¨ï¼š
```cpp
__constant__ float d_camera_pos_x, d_camera_pos_y, d_camera_pos_z;
__constant__ float d_target_pos_x, d_target_pos_y, d_target_pos_z;
__constant__ float d_iResolution_x, d_iResolution_y;
```

é—®é¢˜ï¼š
  â€¢ æ¯ä¸ªå˜é‡å•ç‹¬å£°æ˜
  â€¢ å¯èƒ½å¯¼è‡´å¤šæ¬¡ constant memory load
  
ä¼˜åŒ–ï¼šä½¿ç”¨ç»“æ„ä½“æ‰“åŒ…

### ç“¶é¢ˆ 4: æ²¡æœ‰ä½¿ç”¨ Shared Memory âŒ

å½“å‰ï¼šå®Œå…¨æ²¡æœ‰ä½¿ç”¨ shared memory
æœºä¼šï¼š
  â€¢ Camera vectors (cf, cs, cu) å¯ä»¥æ”¾ shared memory
  â€¢ ä½†è¿™äº›åœ¨æ¯ä¸ª thread éƒ½ä¸åŒï¼Œæ‰€ä»¥å¯èƒ½ä¸é€‚åˆ

### ç“¶é¢ˆ 5: Warp Divergence âš ï¸

é—®é¢˜ä»£ç ï¼š
```cpp
for (int i = 0; i < ray_step; ++i) {
    len = map(ro + rd * t, trap, ID);
    if (fabsf(len) < eps || t > far_plane) break;  // â† æ—©é€€å‡º
    t += len * ray_multiplier;
}
```

é—®é¢˜ï¼š
  â€¢ ä¸åŒ thread çš„ ray å‡»ä¸­ç‰©ä½“çš„æ—¶é—´ä¸åŒ
  â€¢ å¯¼è‡´ warp å†…çš„ thread ç­‰å¾…
  
æ— æ³•ä¼˜åŒ–ï¼ˆè¿™æ˜¯ç®—æ³•å›ºæœ‰çš„ï¼‰

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸš€ å…·ä½“ä¼˜åŒ–å»ºè®®

### ä¼˜åŒ– 1: ä½¿ç”¨ uchar4 å‘é‡åŒ–å†™å…¥ â­â­â­â­â­

å½“å‰ï¼š
```cpp
int idx = i * width * 4 + j * 4;
image[idx + 0] = (unsigned char)fcol.x;
image[idx + 1] = (unsigned char)fcol.y;
image[idx + 2] = (unsigned char)fcol.z;
image[idx + 3] = 255;
```

ä¼˜åŒ–åï¼š
```cpp
int idx = i * width + j;
uchar4 pixel = make_uchar4(
    (unsigned char)fcol.x,
    (unsigned char)fcol.y,
    (unsigned char)fcol.z,
    255
);
((uchar4*)image)[idx] = pixel;  // ä¸€æ¬¡å†™å…¥ 4 å­—èŠ‚ï¼
```

é¢„æœŸæå‡ï¼š10-20%ï¼ˆæ›´å¥½çš„ memory coalescingï¼‰

### ä¼˜åŒ– 2: è°ƒæ•´ Block Size + ä½¿ç”¨ __launch_bounds__ â­â­â­â­â­

```cpp
__global__ void __launch_bounds__(256, 4)  // é™åˆ¶ 4 blocks/SM
render_kernel(...) {
    ...
}

// æˆ–å°è¯•ï¼š
dim3 blockDim(32, 8);  // 256 threads, warp-aligned
```

é¢„æœŸæå‡ï¼š10-30%ï¼ˆæé«˜ occupancyï¼‰

### ä¼˜åŒ– 3: å‡å°‘å¯„å­˜å™¨ä½¿ç”¨ â­â­â­â­

ç­–ç•¥ï¼š
  1. å°†å¤§å‹å±€éƒ¨å˜é‡æ”¹ä¸ºæŒ‰éœ€è®¡ç®—
  2. å‡å°‘é¢„è®¡ç®—çš„å˜é‡æ•°é‡
  3. ä½¿ç”¨ #pragma unroll æ§åˆ¶å¾ªç¯å±•å¼€

ç›®æ ‡ï¼šé™åˆ° 48 regs/thread
æ•ˆæœï¼šOccupancy 50% â†’ 66%

### ä¼˜åŒ– 4: ä¼˜åŒ–å¸¸é‡å†…å­˜å¸ƒå±€ â­â­â­

```cpp
struct CameraParams {
    float3 pos;
    float3 target;
    float2 resolution;
};
__constant__ CameraParams g_camera;

// Kernel å†…ï¼š
vec3 camera_pos = vec3(g_camera.pos.x, g_camera.pos.y, g_camera.pos.z);
```

é¢„æœŸæå‡ï¼š5-10%

### ä¼˜åŒ– 5: ä½¿ç”¨ __restrict__ æŒ‡é’ˆ â­â­

```cpp
__global__ void render_kernel(unsigned char* __restrict__ image, ...) {
```

å‘Šè¯‰ç¼–è¯‘å™¨ image ä¸ä¼š aliasï¼Œå…è®¸æ›´æ¿€è¿›çš„ä¼˜åŒ–ã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

å¦‚æœå®ç°ä¸Šè¿°æ‰€æœ‰ä¼˜åŒ–ï¼š

ä¼˜åŒ– 1 (uchar4):        +15%  â†’ 17.23s â†’ 14.98s
ä¼˜åŒ– 2 (block size):    +20%  â†’ 14.98s â†’ 12.48s
ä¼˜åŒ– 3 (registers):     +15%  â†’ 12.48s â†’ 10.61s
ä¼˜åŒ– 4 (constant mem):  +7%   â†’ 10.61s â†’ 9.87s
ä¼˜åŒ– 5 (__restrict__):  +5%   â†’ 9.87s  â†’ 9.38s

ç†è®ºæœ€ç»ˆï¼š~9.4s (ä» 17.23s)
æå‡ï¼š1.83Ã—

èƒ½å¦è¿›å…¥å‰ 10ï¼Ÿ
  â€¢ ç¬¬ 10 åï¼š13.03s
  â€¢ ä¼˜åŒ–åï¼š9.38s
  â€¢ âœ… å¯èƒ½è¿›å…¥å‰ 5-10 åï¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ¯ è¡ŒåŠ¨è®¡åˆ’

ç«‹å³å®æ–½ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼š
  1. âœ… uchar4 å‘é‡åŒ–å†™å…¥ï¼ˆæœ€å®¹æ˜“ï¼Œæ”¶ç›Šå¤§ï¼‰
  2. âœ… __launch_bounds__ å’Œ block size è°ƒä¼˜
  3. âœ… __restrict__ æŒ‡é’ˆ

åç»­ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰ï¼š
  4. å‡å°‘å¯„å­˜å™¨ä½¿ç”¨ï¼ˆéœ€è¦ä»”ç»†è°ƒæ•´ï¼‰
  5. ä¼˜åŒ–å¸¸é‡å†…å­˜å¸ƒå±€

é«˜çº§ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï¼š
  6. Profile æ‰¾å‡ºçœŸæ­£ç“¶é¢ˆï¼ˆä½¿ç”¨ nvprofï¼‰
  7. è€ƒè™‘ç®—æ³•çº§ä¼˜åŒ–ï¼ˆä½†å¯èƒ½è¿åè§„åˆ™ï¼‰


# HW2 SIFT - æ–¹å‘ä¸€å„ªåŒ–ç¸½çµ

## å„ªåŒ–ç›®æ¨™
å¯¦ç¾ MPI + OpenMP æ··åˆå¹³è¡ŒåŒ–çš„ SIFT æ¼”ç®—æ³•ï¼Œé‡é»åœ¨æ–¼**å„ªåŒ– Pyramid å»ºæ§‹ç­–ç•¥**ï¼Œé¿å…æ‰€æœ‰ ranks é‡è¤‡å»ºæ§‹å®Œæ•´é‡‘å­—å¡”ã€‚

## å·²å®Œæˆçš„å„ªåŒ–

### 1. MPI åˆ†æ•£å¼è™•ç†æ¶æ§‹ âœ…
- **åœ–åƒå»£æ’­** (`mpi_broadcast_image`): Rank 0 è®€å–åœ–åƒä¸¦å»£æ’­çµ¦æ‰€æœ‰ ranks
- **Octave åˆ†é…** (`compute_octave_partition`): å°‡ 8 å€‹ octaves å¹³å‡åˆ†é…çµ¦ä¸åŒ processes
- **çµæœæ”¶é›†** (`mpi_gather_keypoints`): æ”¶é›†æ‰€æœ‰ ranks çš„ keypoints åˆ° rank 0

### 2. OpenMP åŸ·è¡Œç·’å¹³è¡ŒåŒ– âœ…
å„ªåŒ–çš„å‡½æ•¸åŒ…æ‹¬ï¼š

#### `generate_dog_pyramid` (DoG é‡‘å­—å¡”ç”Ÿæˆ)
- ä½¿ç”¨ `#pragma omp parallel for schedule(static)` å¹³è¡Œè™•ç†ä¸åŒ octaves
- ä½¿ç”¨ `#pragma omp simd` å‘é‡åŒ–åƒç´ ç´šé‹ç®—

#### `find_keypoints` (é—œéµé»æª¢æ¸¬)
- **å…©éšæ®µå¹³è¡ŒåŒ–**ï¼š
  - Phase 1: å¹³è¡Œæª¢æ¸¬å€™é¸æ¥µå€¼é»ï¼Œä½¿ç”¨ `collapse(2)` å’Œ `schedule(dynamic)`
  - Phase 2: å¹³è¡Œå„ªåŒ–å’Œé©—è­‰é—œéµé»ï¼Œä½¿ç”¨ `schedule(dynamic)` è™•ç†è² è¼‰ä¸å¹³è¡¡
- ä½¿ç”¨ thread-local ç·©è¡å€æ¸›å°‘ critical section é–‹éŠ·

#### `generate_gradient_pyramid` (æ¢¯åº¦é‡‘å­—å¡”)
- å¤–å±¤ octaves ä½¿ç”¨ `schedule(static)`
- å…§å±¤åƒç´ ä½¿ç”¨ `collapse(2)` å’Œ `schedule(static)`

#### `find_keypoints_and_descriptors` (æè¿°ç¬¦è¨ˆç®—)
- ä½¿ç”¨ `schedule(dynamic)` å¹³è¡Œè¨ˆç®—ä¸åŒé—œéµé»çš„æè¿°ç¬¦
- Thread-local ç·©è¡å€æ”¶é›†çµæœ

#### `gaussian_blur` (é«˜æ–¯æ¨¡ç³Š)
- å‚ç›´å’Œæ°´å¹³å·ç©éƒ½ä½¿ç”¨ `collapse(2)` å’Œ `schedule(static)`
- é€™æ˜¯æœ€è€—æ™‚çš„æ“ä½œä¹‹ä¸€ï¼Œå„ªåŒ–æ•ˆæœé¡¯è‘—

### 3. `find_keypoints_range` - MPI åˆ†æ•£å¼è™•ç†æ ¸å¿ƒ âœ…
- æ¯å€‹ rank åªè™•ç†åˆ†é…çµ¦å®ƒçš„ octaves ç¯„åœ
- çµåˆ OpenMP åœ¨æ¯å€‹ rank å…§é€²è¡ŒåŸ·è¡Œç·’å¹³è¡ŒåŒ–
- å…©éšæ®µè™•ç†ï¼šå€™é¸é»æª¢æ¸¬ â†’ æè¿°ç¬¦è¨ˆç®—

## æ¸¬è©¦çµæœ

### æ¸¬è©¦ç’°å¢ƒ
- æ¸¬è©¦æ¡ˆä¾‹ï¼štestcases/01.jpg
- é…ç½®ï¼š6 cores per process
- é©—è­‰ï¼šä½¿ç”¨ validate.py å°ç…§ golden files

### æ€§èƒ½æ•¸æ“š
| é…ç½® | åŸ·è¡Œæ™‚é–“ | Keypoints | é©—è­‰çµæœ | åŠ é€Ÿæ¯” |
|------|---------|-----------|---------|--------|
| N=1, n=1, c=6 | 17921.8 ms | 45730 | Pass | 1.00x |
| N=1, n=2, c=6 | 17031.1 ms | 45730 | Pass | 1.05x |

### è§€å¯Ÿèˆ‡åˆ†æ
1. âœ… **æ­£ç¢ºæ€§**: å…©ç¨®é…ç½®éƒ½é€šéé©—è­‰ï¼Œæ‰¾åˆ°ç›¸åŒæ•¸é‡çš„ keypoints
2. âœ… **åˆæ­¥åŠ é€Ÿ**: ä½¿ç”¨ 2 å€‹ processes å·²ç¶“æœ‰ç´„ 5% çš„åŠ é€Ÿ
3. ğŸ“Š **æ”¹é€²ç©ºé–“**: ç›®å‰æ‰€æœ‰ ranks ä»å»ºæ§‹å®Œæ•´é‡‘å­—å¡”ï¼Œé€™æ˜¯ä¸‹ä¸€æ­¥å„ªåŒ–é‡é»

## ç•¶å‰æ¶æ§‹èªªæ˜

### hw2.cpp ä¸»æµç¨‹
```cpp
1. MPI_Init - åˆå§‹åŒ– MPI ç’°å¢ƒ
2. Rank 0 è®€å–åœ–åƒä¸¦è½‰ç‚ºç°éš
3. mpi_broadcast_image - å»£æ’­åœ–åƒåˆ°æ‰€æœ‰ ranks
4. compute_octave_partition - è¨ˆç®—æ¯å€‹ rank çš„ octave åˆ†é…
5. æ¯å€‹ rank:
   - å»ºæ§‹å®Œæ•´çš„ Gaussian/DoG/Gradient pyramids (å¾…å„ªåŒ–)
   - åªè™•ç†åˆ†é…çµ¦è‡ªå·±çš„ octaves (å·²å„ªåŒ–)
6. mpi_gather_keypoints - æ”¶é›†æ‰€æœ‰ keypoints åˆ° rank 0
7. Rank 0 å¯«å…¥çµæœä¸¦è¼¸å‡ºæ™‚é–“
8. MPI_Finalize
```

### èª¿åº¦ç­–ç•¥
- **Static scheduling**: ç”¨æ–¼è² è¼‰å‡è¡¡çš„ä»»å‹™ (é‡‘å­—å¡”ç”Ÿæˆã€æ¢¯åº¦è¨ˆç®—)
- **Dynamic scheduling**: ç”¨æ–¼è² è¼‰ä¸å‡çš„ä»»å‹™ (é—œéµé»æª¢æ¸¬ã€æè¿°ç¬¦è¨ˆç®—)
- **Collapse(2)**: å¢åŠ å¹³è¡Œç²’åº¦ï¼Œæ¸›å°‘æ’ç¨‹é–‹éŠ·

## ä¸‹ä¸€æ­¥å„ªåŒ–æ–¹å‘

### æ–¹å‘ 1 é€²éšå„ªåŒ– (Pyramid å»ºæ§‹å„ªåŒ–)
ç›®å‰ç‹€æ…‹ï¼š**æ‰€æœ‰ ranks å»ºæ§‹å®Œæ•´é‡‘å­—å¡”ï¼Œç„¶å¾Œåªè™•ç†éƒ¨åˆ† octaves**

å„ªåŒ–ç­–ç•¥ï¼š
1. **é¸é … A**: Rank 0 å»ºæ§‹é‡‘å­—å¡”å¾Œä½¿ç”¨ MPI_Scatterv åˆ†ç™¼å°æ‡‰ octaves
2. **é¸é … B**: æ¯å€‹ rank åªå»ºæ§‹è‡ªå·±éœ€è¦çš„ octaves
3. **é¸é … C**: Pipeline è™•ç† - é‡ç–Šè¨ˆç®—å’Œé€šè¨Š

### æ–¹å‘ 2: è² è¼‰å¹³è¡¡
- åŸºæ–¼åœ–åƒå¤§å°å’Œé—œéµé»å¯†åº¦çš„å‹•æ…‹åˆ†é…
- è€ƒæ…®ä¸åŒ octaves çš„å¯¦éš›å·¥ä½œé‡

### æ–¹å‘ 3: é€šè¨Šå„ªåŒ–
- ä½¿ç”¨éé˜»å¡ MPI æ“ä½œ (MPI_Ibcast, MPI_Igatherv)
- æ¸›å°‘æ•¸æ“šå‚³è¼¸é‡

### æ–¹å‘ 4: æ¼”ç®—æ³•å„ªåŒ–
- SIMD å‘é‡åŒ–æ›´å¤šè¨ˆç®—å¯†é›†éƒ¨åˆ†
- æ”¹å–„ cache locality
- æ¸›å°‘ critical sections

## ç·¨è­¯å’Œæ¸¬è©¦å‘½ä»¤

### ç·¨è­¯
```bash
cd /home/p13922006/Parallelism/hw2
bash compile_test.sh
```

### å¿«é€Ÿæ¸¬è©¦
```bash
bash quick_test.sh
```

### å®Œæ•´æ¸¬è©¦
```bash
bash test_judge.sh
```

## é—œéµæ–‡ä»¶èªªæ˜
- `hw2.cpp`: MPI ä¸»ç¨‹å¼ï¼Œè™•ç†åˆ†æ•£å¼å”èª¿
- `sift.hpp/cpp`: SIFT æ¼”ç®—æ³•å¯¦ç¾ï¼ŒåŒ…å« MPI è¼”åŠ©å‡½æ•¸
- `image.hpp/cpp`: åœ–åƒè™•ç†å‡½æ•¸ï¼ŒåŒ…å«é«˜æ–¯æ¨¡ç³Šç­‰
- `compile_test.sh`: ç·¨è­¯è…³æœ¬
- `quick_test.sh`: å¿«é€Ÿæ¸¬è©¦è…³æœ¬

## ä½œæ¥­è¦æ±‚æª¢æŸ¥æ¸…å–®
- âœ… ä½¿ç”¨ MPI é€²è¡Œåˆ†æ•£å¼è™•ç†
- âœ… ä½¿ç”¨ OpenMP é€²è¡ŒåŸ·è¡Œç·’å¹³è¡ŒåŒ–
- âœ… æ··åˆ Static å’Œ Dynamic scheduling
- âœ… è€ƒæ…®è² è¼‰å¹³è¡¡ï¼ˆä½¿ç”¨ dynamic schedulingï¼‰
- âœ… ä¸ä¿®æ”¹ SIFT åƒæ•¸ï¼ˆä¿æŒç®—æ³•æ­£ç¢ºæ€§ï¼‰
- âœ… ä¸ä¿®æ”¹é©—è­‰ç›¸é—œä»£ç¢¼
- âœ… è¼¸å‡ºæ­£ç¢ºä¸”é€šéé©—è­‰

## ç¸½çµ
**æ–¹å‘ä¸€çš„å„ªåŒ–å·²æˆåŠŸå¯¦ç¾åŸºç¤æ¶æ§‹**ï¼š
1. âœ… MPI åˆ†æ•£å¼è™•ç†æ¡†æ¶å®Œæ•´
2. âœ… OpenMP å¤šåŸ·è¡Œç·’å„ªåŒ–åˆ°ä½
3. âœ… ç¨‹å¼æ­£ç¢ºæ€§é©—è­‰é€šé
4. âœ… å·²æœ‰åˆæ­¥åŠ é€Ÿæ•ˆæœ
5. ğŸ“ˆ å¾ŒçºŒå„ªåŒ–ç©ºé–“æ˜ç¢º

ä¸‹ä¸€æ­¥å¯ä»¥ç¹¼çºŒå„ªåŒ– Pyramid å»ºæ§‹ç­–ç•¥ï¼Œæˆ–é€²è¡Œå…¶ä»–æ–¹å‘çš„å„ªåŒ–ä¾†é€²ä¸€æ­¥æå‡æ€§èƒ½ã€‚

